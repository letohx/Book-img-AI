<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book img AI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f0f5;
            display: flex;
            justify-content: center;
        }

        .wrapper {
            text-align: center;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            width: 100%;
        }

        h1 {
            font-size: 2.2rem;
            color: #2c3e50;
            margin-bottom: 20px;
        }

        textarea, select, input[type="number"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        button {
            width: 100%;
            padding: 15px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #2980b9;
        }

        img {
            margin-top: 20px;
            max-width: 100%;
            height: auto;
            display: block;
            margin-left: auto;
            margin-right: auto;
            cursor: pointer;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            font-size: 1.2rem;
            margin-bottom: 5px;
            display: block;
        }

        .size-img {
            display: flex;
            justify-content: space-evenly;
        }

    </style>
    <script src="https://code.responsivevoice.org/responsivevoice.js"></script>
    <script>
        const key = "CB877DFF3660DE7C80599E533C090123";
        const secret = "4A329B2763F032D01B680EF8C1E3F23D";
        let prd = null;
        let uuid = '';
        let currentIndex = 0;

        function headers() {
            return {
                'X-Key': 'Key ' + key,
                'X-Secret': 'Secret ' + secret,
            };
        }

        function params() {
            return {
                type: "GENERATE",
                style: style.value,
                width: width.value,
                height: height.value,
                num_images: 1,
                negativePromptUnclip: "",
                generateParams: {
                    query: document.getElementById('summaryText').innerText,
                }
            };
        }

        async function generate() {
            try {
                let model_id = 0;
                let res = await fetch('https://api-key.fusionbrain.ai/key/api/v1/models', {
                    method: 'GET',
                    headers: headers(),
                });
                const models = await res.json();
                model_id = models[0]?.id;

                if (!model_id) {
                    console.error('Model ID not found');
                    return;
                }

                let formData = new FormData();
                formData.append('model_id', model_id);
                formData.append('params', new Blob([JSON.stringify(params())], { type: "application/json" }));

                let imageResponse = await fetch('https://api-key.fusionbrain.ai/key/api/v1/text2image/run', {
                    method: 'POST',
                    headers: headers(),
                    body: formData,
                });
                let imageResult = await imageResponse.json();
                uuid = imageResult.uuid;

                if (!uuid) {
                    console.error('UUID not generated');
                    return;
                }

                prd = setInterval(check, 3000);
            } catch (error) {
                console.error('Error generating image:', error);
            }
        }

        async function check() {
            try {
                let res = await fetch('https://api-key.fusionbrain.ai/key/api/v1/text2image/status/' + uuid, {
                    method: 'GET',
                    headers: headers(),
                });
                let json = await res.json();

                if (json.status === 'DONE') {
                    document.getElementById('img').src = 'data:image/jpeg;charset=utf-8;base64,' + json.images[0];
                    clearInterval(prd);
                } else if (json.status === 'ERROR') {
                    console.error('Error in image generation');
                    clearInterval(prd);
                }
            } catch (error) {
                console.error('Error checking image status:', error);
            }
        }

        function autoSetSize() {
            let screenWidth = screen.width;
            let screenHeight = screen.height;
            document.getElementById('width').value = screenWidth;
            document.getElementById('height').value = screenHeight;
        }

        async function summarizeText(text) {
            const summaryText = document.getElementById('summaryText');
            summaryText.innerText = '';

            try {
                const response = await fetch('/.netlify/functions/summarize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });

                const data = await response.json();
                summaryText.innerText = data.summary;
                generate(); // Запуск генерации изображения после сокращения текста
            } catch (error) {
                summaryText.innerText = `Error processing your request.`;
            }
        }

        function speakNext() {
            const text = document.getElementById('textToSpeak').value;
            const voice = document.getElementById('voiceselection').value;
            const wordCount = parseInt(document.getElementById('wordCount').value);
            const words = text.split(/\s+/);

            if (currentIndex >= words.length) {
                alert("End of text.");
                return;
            }

            const nextWords = words.slice(currentIndex, currentIndex + wordCount).join(' ');
            document.getElementById('currentText').value = nextWords;

            summarizeText(nextWords); // Сокращаем текст перед озвучиванием

            responsiveVoice.speak(nextWords, voice, {
                onend: () => {
                    currentIndex += wordCount;
                    speakNext(); // Продолжаем озвучивание следующей порции
                }
            });
        }

        function startCycle() {
            currentIndex = 0; // Сбрасываем индекс при новом запуске
            speakNext(); // Начинаем озвучивание и сокращение
        }

        window.onload = async () => {
            let res = await fetch('https://cdn.fusionbrain.ai/static/styles/web');
            res = await res.json();
            for (let style of res) {
                document.getElementById('style').innerHTML += `<option value="${style.name}">${style.name}</option>`;
            }

            const imgElement = document.getElementById('img');
            imgElement.addEventListener('click', function () {
                if (!document.fullscreenElement) {
                    if (this.requestFullscreen) {
                        this.requestFullscreen();
                    } else if (this.mozRequestFullScreen) {
                        this.mozRequestFullScreen();
                    } else if (this.webkitRequestFullscreen) {
                        this.webkitRequestFullscreen();
                    } else if (this.msRequestFullscreen) {
                        this.msRequestFullscreen();
                    }
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    } else if (document.mozCancelFullScreen) {
                        document.mozCancelFullScreen();
                    } else if (document.webkitExitFullscreen) {
                        document.webkitExitFullscreen();
                    } else if (document.msExitFullscreen) {
                        document.msExitFullscreen();
                    }
                }
            });
        }
    </script>
</head>
<body>
    <div class="wrapper">
        <h1>Book Image AI</h1>
        <div class="input-group">
            <textarea id="textToSpeak" rows="8" placeholder="Enter text here..."></textarea>
            <textarea id="currentText" rows="5" readonly></textarea>

            <label for="wordCount">Number of words at a time:</label>
            <input type="number" id="wordCount" min="1" value="50">

            <label for="voiceselection">Choose voice:</label>
            <select id="voiceselection">
                <option value="Russian Female">Russian Female</option>
                <option value="Russian Male">Russian Male</option>
                <option value="UK English Female">UK English Female</option>
                <option value="UK English Male">UK English Male</option>
                <option value="US English Female">US English Female</option>
                <option value="US English Male">US English Male</option>
                <option value="Polish Male">Polish Male</option>
                <option value="Polish Female">Polish Female</option>
                <option value="Romanian Female">Romanian Female</option>
                <option value="Slovak Female">Slovak Female</option>
                <option value="Ukrainian Female">Ukrainian Female</option>
                <option value="Serbo-Croatian Male">Serbo-Croatian Male</option>
                <option value="Bosnian Male">Bosnian Male</option>
            </select>

            <div class="size-img">
                <div class="input-group">
                    <label>Width</label>
                    <input id="width" type="number" value="1920" size="5">
                </div>
    
                <div class="input-group">
                    <label>Height</label>
                    <input id="height" type="number" value="1080" size="5">
                </div>
            </div>

            <button onclick="autoSetSize()">Auto size image</button>
            <div class="input-group">
                <label>Style image</label>
                <select id="style"></select>
            </div>

            <button onclick="startCycle()">Start</button>
            <div id="summaryText"></div><br>
        </div>

        <img src="https://www.research.autodesk.com/app/uploads/2023/01/ai.jpg" id="img" title="Generated image">
    </div>
</body>
</html>
